{% extends 'base2.html' %}
{% load static %}
{% block title %}Master e Igrometri sulla Mappa{% endblock %}
{% block head %}
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />{% endblock %}
{% block content %}
<div class="container-fluid header bg-white p-0">
            <div class="row g-0 align-items-center flex-column-reverse flex-md-row">
                <div class="col-md-6 p-5 mt-lg-5">
                    <h1 class="display-5 animated fadeIn mb-4">Search the hygrometers usign this <span class="text-primary">Map</span>  </h1>
                    <p class="animated fadeIn mb-4 pb-2">Vero elitr justo clita lorem. Ipsum dolor at sed stet
                        sit diam no. Kasd rebum ipsum et diam justo clita et kasd rebum sea elitr.</p>
                </div>
                <div class="col-md-6 animated fadeIn">
                    <img class="img-fluid" src='{% static "img/mappa2.jpeg" %}' alt="">
 
                    
                </div>
            </div>
        </div>
        <!-- Header End -->

<!-- Search Start -->
<div class="container-fluid bg-primary mb-5 wow fadeIn" data-wow-delay="0.1s" style="padding: 35px;">
    <div class="container">
        <div class="row g-2">
            <div class="col-md-10">
                <div class="row g-2">
                    <div class="col-md-4">
                        <input type="text" class="form-control border-0 py-3" placeholder="Search name">
                    </div>
                    <div class="col-md-4">
                        <select class="form-select border-0 py-3" id="type">
                            <option selected>Type</option>
                            <option value="Master">Master</option>
                            <option value="Hygrometer">Hygrometer</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select border-0 py-3">
                            <option selected>Location</option>
                            <option value="1">Location 1</option>
                            <option value="2">Location 2</option>
                            <option value="3">Location 3</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <button class="btn btn-dark border-0 w-100 py-3">Search</button>
            </div>
        </div>
    </div>
</div>
<!-- Search End -->
<div class="container-fluid header bg-white p-0">


    <h1 style="margin-top: 500px;">Master e Igrometri sulla Mappa </h1>
    <div class="container-xxl py-5">
        <div class="container">
            <div class="bg-light rounded p-1" style="background-color: #6594a67e !important;">
                <div id="map" style="height: 400px; width: 100%;"></div>
            </div>
            
        </div>

    
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>


</div>
</div>
    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src='{% static "js/wow.min.js" %}'></script>
    <script src='{% static "js/easing.min.js" %}'></script>
    <script src='{% static "js/waypoints.min.js" %}'></script>
    <script src='{% static "js/owl.carousel.min.js" %}'></script>

    <!-- Template Javascript -->
    <script src='{% static "js/main.js" %}'></script>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script>
        {% load static %}
        var map = L.map('map').setView([{{ masters.0.latitudine }}, {{ masters.0.longitudine }}], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        var igrometroIcon = L.icon({
            iconUrl: '{% static "img/marker.png" %}',
            iconSize: [20, 22],
            iconAnchor: [22, 64],
            popupAnchor: [-3, -76],
        });

        // Aggiungi azione di scorrimento quando viene fatto clic su un collegamento
        document.querySelectorAll('.map-link').forEach(function(link) {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                var lat = parseFloat(e.target.getAttribute('data-lat'));
                var lon = parseFloat(e.target.getAttribute('data-lon'));
                map.setView([lat, lon], 15);
            });
        });

        {% for master in masters %}
            L.marker([{{ master.latitudine }}, {{ master.longitudine }}], {id: 'master_{{ master.id }}'})
                .bindPopup("Nome: {{ master.nome }}<br>ID: {{ master.id }}")
                .addTo(map);

            {% for igrometro in master.igrometro_set.all %}
                L.marker([{{ igrometro.latitudine }}, {{ igrometro.longitudine }}], {icon: igrometroIcon, id: 'igrometro_{{ igrometro.id }}'})
                    .bindPopup("Nome: {{ igrometro.nome }}<br>ID: {{ igrometro.id }}")
                    .addTo(map);
            {% endfor %}
        {% endfor %}
    </script>

<script>
    $(document).ready(function() {
        // Quando il pulsante di ricerca viene premuto
        $('.btn-dark').click(function() {
            // Recupera i valori di ricerca
            var searchName = $('input').val();
            var type = $('select#type').val();
            var location = $('select#location').val();

            console.log(searchName);
            console.log(type);


            // Invia la richiesta Ajax
            $.ajax({
                url: '/search/',  // Sostituisci con il percorso del tuo endpoint sul server
                method: 'GET',
                data: {
                    searchName: searchName,
                    type: type,
                    location: location
                },
                success: function(data) {
                    // Aggiorna la variabile masters con i nuovi risultati ottenuti
                    masters = data;

                    map.eachLayer(function(layer) {
                        map.removeLayer(layer);
                      });

                      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

                    data["masters"].forEach(function(master) {
        L.marker([master.latitudine, master.longitudine], {id: 'master_' + master.id})
            .bindPopup("Nome: " + master.nome + "<br>ID: " + master.id)
            .addTo(map);
            
                    
       
    }); 
    data["igrometri"].forEach(function(igrometro) {
    L.marker([igrometro.latitudine, igrometro.longitudine], {icon: igrometroIcon, id: 'igrometro_' + igrometro.id})
                    .bindPopup("Nome: " + igrometro.nome + "<br>ID: " + igrometro.id)
                    .addTo(map);
                }); 
                updateSearchResults(data)
                    console.log(data)
                    // Aggiorna la mappa con i nuovi dati
                    
                },
                error: function(error) {
                    console.error('Errore durante la richiesta Ajax:', error);
                }
            });
        });

        // Funzione per aggiornare la mappa con i nuovi dati
        function updateMap() {
            // Rimuovi tutti i layer dalla mappa
            map.eachLayer(function(layer) {
                map.removeLayer(layer);
            });

            // Ricrea la mappa base
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Aggiungi i nuovi marcatori
           
        }
    });
</script>

<!-- ... (parte del tuo codice) ... -->

<div class="container-fluid header bg-white p-0">
    <!-- ... (altro contenuto) ... -->

    <!-- Risultati della ricerca -->
    <div id="search-results" class="container py-5">
        <!-- Qui verranno aggiunti dinamicamente i risultati della ricerca -->
    </div>

    <!-- ... (altra parte del tuo codice) ... -->
</div>

<script>
    // Funzione per aggiornare la sezione dei risultati della ricerca
    function updateSearchResults(data) {
        // Ottieni il contenitore dei risultati
        var resultsContainer = document.getElementById('search-results');

        // Svuota il contenitore dei risultati
        resultsContainer.innerHTML = '';

        // Aggiungi i nuovi blocchi per ogni risultato
        data["masters"].forEach(function(master) {
            console.log("ao");
            var masterBlock = createResultBlock('Master', master);
            resultsContainer.appendChild(masterBlock);
        });
        console.log("asg");
        console.log(data);
        data["igrometri"].forEach(function(igrometro) {
            var igrometroBlock = createResultBlock('Hygrometer', igrometro);
            console.log("ciao");
            resultsContainer.appendChild(igrometroBlock);
        });
    }

    // Funzione per creare un blocco risultato
    function createResultBlock(type, data) {
        var block = document.createElement('div');
        block.className = 'result-block card mb-3';

        // Creare l'intestazione del blocco
        var header = document.createElement('div');
        header.className = 'card-header';
        header.innerHTML = '<h3 class="mb-0">' + data.nome + '</h3>';
        block.appendChild(header);

        // Creare il corpo del blocco
        var body = document.createElement('div');
        body.className = 'card-body';

        // Aggiungi le informazioni specifiche al corpo del blocco
        if (type === 'Master') {
            body.innerHTML = '<p>ID: ' + data.id + '</p>' +
                             '<p>Latitudine: ' + data.latitudine + '</p>' +
                             '<p>Longitudine: ' + data.longitudine + '</p>' +
                             '<p>Data Creazione: ' + data.data_creazione + '</p>' +
                             '<p>Quota: ' + data.quota + '</p>';
        } else if (type === 'Hygrometer') {
            body.innerHTML = '<p>ID: ' + data.id + '</p>' +
                             '<p>Latitudine: ' + data.latitudine + '</p>' +
                             '<p>Longitudine: ' + data.longitudine + '</p>' +
                             '<p>Data Creazione: ' + data.data_creazione + '</p>' +
                             '<p>Ultima Misurazione: ' + data.ultima_misurazione + '</p>' +
                             '<p>Misurazioni: ' + data.misurazioni + '</p>' +
                             '<p>Attivo: ' + data.attivo + '</p>' +
                             '<p>Master ID: ' + data.master_id + '</p>';
        }

        // Aggiungi il corpo al blocco
        block.appendChild(body);

     // Aggiungi il pulsante per aprire/chiudere il blocco
var collapseBtn = document.createElement('button');
collapseBtn.className = 'btn btn-link btn-block text-left';
collapseBtn.type = 'button';
collapseBtn.setAttribute('data-bs-toggle', 'collapse');
collapseBtn.setAttribute('data-bs-target', '#collapse-' + data.id);
collapseBtn.setAttribute('aria-expanded', 'false');
collapseBtn.setAttribute('aria-controls', 'collapse-' + data.id);
collapseBtn.innerHTML = 'Mostra Dettagli';

// Aggiungi un gestore di eventi 'click' al pulsante
collapseBtn.addEventListener('click', function() {
    // Cambia il testo del pulsante quando viene cliccato
    collapseBtn.innerText = collapseBtn.innerText === 'Mostra Dettagli' ? 'Nascondi Dettagli' : 'Mostra Dettagli';

    // Recupera il target della tendina
    var collapseTarget = $('#collapse-' + data.id);

    // Controlla se la tendina è attualmente aperta o chiusa
    var isCollapsed = collapseTarget.hasClass('show');

    // Se la tendina è stata aperta, modifica il testo del pulsante
    if (!isCollapsed) {
        collapseBtn.innerText = 'Nascondi Dettagli';
    }
});

body.appendChild(collapseBtn);

// Aggiungi il div di dettagli nascosto
var collapseDiv = document.createElement('div');
collapseDiv.className = 'collapse';
collapseDiv.id = 'collapse-' + data.id;
collapseDiv.innerHTML = 'Dettagli aggiuntivi qui...';

body.appendChild(collapseDiv);

return block;

    }
</script>

<!-- ... (altro codice JavaScript) ... -->
{% endblock %}